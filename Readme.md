Инструкция по установке и функционалу программы TemperatureStabilization
# Необходимые инструменты
Чтобы установить данную программу понадобится:
- Компилятор gcc(https://gcc.gnu.org/)
- git(инструкции по установке здесь https://git-scm.com/book/ru/v2/%D0%92%D0%B2%D0%B5%D0%B4%D0%B5%D0%BD%D0%B8%D0%B5-%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0-Git)
- Утилита make(установка зависит от вашей ОС, например для Ubuntu https://andreyex.ru/ubuntu/kak-ustanovit-make-na-ubuntu/)
- Библиотека XML-RPC(https://xmlrpc-c.sourceforge.io/downloading.php)
# Установка
Установка утилиты очень простая и включает всего несколько шагов:
- Скопируйте репозиторий командой git clone https://github.com/Coolarsic/C_microcontrollers
- Перейдите в репозиторий командой cd C_microcontrollers
- Вставьте свой токен в константу EXPERIMENT_TOKEN в файле constants.c
- Укажите путь до файлов base.h и client.h библиотеки xmlrpc в файлах dieIfFaultOccured.c, get_thermocouple_signal_mV.c и main.c
- Соберите утилиту из исходников командой make install
- Запустите командой make run 

По умолчанию утилита выводит в консоль три строчки:
 - Сигнал с термопары в мВ
 - Температуру диода в градусах Цельсия
 - Текущее значение тока через элемент Пельтье

Также можно раскомментировать строчки 125-130 для вывода значений добавок PID-регулятора
# Под капотом
Итак, что же происходит внутри программы? Сперва теория про PID-регулятор. Это устройство, управляющее некоторым процессом при помощи обратной связи. Логика управления проста: мы задаём некоторое значение сигнала, которого хотим достичь(например, хотим температуру 293K) и считываем значение температуры в текущий момент времени. Самая простая модель: чем больше отклонение от этой температуры, тем больше будем прикладывать сил, чтобы достичь нужной температуры. Например, для элемента Пельтье чем большее будет отклонение по температуре, тем больший ток будем пускать. Установим прямую зависимость между невязкой(разницей между нужной температурой и текущей) и током. Тогда получим P-регулятор(proportional). Однако такая модель не годится, ведь температура постоянно будет "проскакивать" нужную температуру и никогда не остановится на нужной, а график температуры будет синусоидальным. Тогда попробуем добавить компоненту, которая будет "сглаживать" этот график. Например, чем больше по времени температура будет ниже желаемой, тем больше будет ток. Это позволит сгладить синусоиду и свести ошибку к минимуму через некоторый промежуток времени. Это PI(Proportional-integral) регулятор. В таком виде он используется во многих устройствах, где не нужно резко сглаживать скачки температуры. Ну и вот, у нас есть PI-регулятор. Однако, при резких скачках окружающей температуры он не успевает среагировать. Тогда добавим ещё одно слагаемое, которое будет учитывать резкое изменение ошибки. В таком случае, мы переизобретём PID-регулятор. Вся вышеописанная логика заложена в данной программе. Основная формула PID-регулятора: 

u(t) = Kp·e(t) + Ki·∫e(τ)dτ + Kd·de(t)/dt

Где e(t) - невязка, u(t) - регулируемый сигнал(в данном случае ток), $K_p$, $K_i$, $K_d$ пока неизвестные коэффициенты.
Зная это, идём смотреть код main.c. В строчке (63) запускаем симуляцию. Дальше в строчках 73-75 объявляем переменные: 

`peltier_current` - ток через элемент Пельтье, который мы будем регулировать, 

`thermocouple_voltage_mV` - сигнал с термопары и 

`temperature` - температура в данный момент(получим её из напряжения между контактами термопары). Далее в строках 94-97 - 

`mismatch` - текущая невязка, то есть e(t)

`previous_mismatch` - невязка в предыдущий момент времени, 

`integral_mismatch` - переменная для вычисления суммы ошибок то есть это ∫e(τ)dτ

`differential_mismatch` - разность между текущей невязкой и предыдущей, то есть это de(t)/dt

В строке 99 мы запускаем цикл для периодического считывания показателей с термопары. В строке 101 - получаем напряжение с термопары с удалённого сервера, а в строке 102 - преобразуем напряжение в температуру(температуру получаем из формулы разложения в полином из файла https://meganorm.ru/Data2/1/4294815/4294815957.pdf)
Далее считаем ошибку, добавляем к сумме ошибок e(t)dt и вычисляем производную невязки. В строчках 112-117 ограничиваем ток через элемент Пельтье, чтобы он не вышел из строя. В строчке 119 - устанавливаем напряжение элемента Пельтье. Остаётся лишь вопрос в том, как рассчитать коээфициенты $K_p$, $K_i$ и $K_d$,
чтобы PID работал наиболее эффективно. Есть много алгоритмов их нахождения и один из самых простых - алгоритм Циглера-Никольса. Это - эмпирический алгоритм. Заключается он в том, чтобы сперва обнулить все коэффициенты и начать увеличивать $K_p$
При слишком малом $K_p$ температура не дойдёт до нужной и выйдет на "плато": мощности элемента Пельтье не хватит, чтобы нагреть диод до нужной температуры, часть теплоты будет уходить в окружающую среду. При дальнейшем увеличении $K_p$ начнутся колебания температуы около нужной(та самая синусоида). Алгоритм Циглера-Никольса заключается в том, чтобы найти такой $K_p$ при котором начнутся колебания, а после рассчитать $K_i$ и $K_d$ по формулам:

$K_p$ = 0.6 * K 

$K_i$ = 2 * K / T 

$K_d$ = K * T/8

где $K$ - $K_p$, при котором начались колебания температуры.

